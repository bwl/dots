#!/bin/bash

# SketchyBar Configuration
# Minimal starter config with workspace info, system monitoring, and custom plugin support
# Reload: sketchybar --reload

# Source color and icon definitions
source "$HOME/.config/sketchybar/colors.sh"
source "$HOME/.config/sketchybar/icons.sh"

PLUGIN_DIR="$HOME/.config/sketchybar/plugins"

# ============================================================================
# Bar Appearance
# ============================================================================

sketchybar --bar \
    position=top \
    height=40 \
    blur_radius=0 \
    color=$BAR_COLOR \
    padding_left=12 \
    padding_right=12 \
    margin=0 \
    corner_radius=0 \
    y_offset=0 \
    shadow=off

# ============================================================================
# Default Item Settings
# ============================================================================

sketchybar --default \
    icon.font="IosevkaTerm Nerd Font Mono:Bold:16.0" \
    icon.color=$ICON_COLOR \
    label.font="IosevkaTerm Nerd Font Mono:Bold:14.0" \
    label.color=$LABEL_COLOR \

# ============================================================================
# Left Side - Workspace/Space Indicators
# ============================================================================

SPACE_ICONS=("1" "2" "3" "4" "5" "6" "7" "8" "9" "10")

for i in "${!SPACE_ICONS[@]}"
do
    sid=$(($i+1))
    sketchybar --add space space.$sid left \
        --set space.$sid \
            associated_space=$sid \
            icon="${SPACE_ICONS[i]}" \
            icon.padding_left=8 \
            icon.padding_right=8 \
            background.color=$SPACE_BG \
            background.corner_radius=5 \
            background.height=20 \
            label.drawing=off \
            script="$PLUGIN_DIR/space.sh" \
        --subscribe space.$sid space_change mouse.clicked
done

# Space separator
sketchybar --add item space_separator left \
    --set space_separator \
        icon="$ICON_SEPARATOR" \
        padding_left=10 \
        padding_right=10 \
        label.drawing=off

# Front app
sketchybar --add item front_app left \
    --set front_app \
        icon.drawing=on \
        script="$PLUGIN_DIR/front_app.sh" \
        label.color=$ACCENT_COLOR \
    --subscribe front_app front_app_switched

# ============================================================================
# Right Side - System Info
# ============================================================================

# Clock
sketchybar --add item clock right \
    --set clock \
        update_freq=10 \
        padding_left=12 \
        script="$PLUGIN_DIR/clock.sh" \
        click_script="open -a Calendar"

# Battery
sketchybar --add item battery right \
    --set battery \
        update_freq=30 \
        padding_left=12 \
        icon.padding_right=4 \
        icon="$ICON_BATTERY" \
        script="$PLUGIN_DIR/battery.sh" \
        click_script="open x-apple.systempreferences:com.apple.preference.battery" \
    --subscribe battery system_woke power_source_change

# Network
sketchybar --add item network right \
    --set network \
        update_freq=5 \
        padding_left=12 \
        icon.padding_right=4 \
        icon="$ICON_WIFI" \
        script="$PLUGIN_DIR/network.sh" \
        click_script="open x-apple.systempreferences:com.apple.Network-Settings.extension"


# Memory
sketchybar --add item memory right \
    --set memory \
        update_freq=5 \
        padding_left=12 \
        script="$PLUGIN_DIR/memory.sh" \
        click_script="open -a 'Activity Monitor'"

# Get number of cores
NUM_CORES=$(sysctl -n hw.ncpu)

# Add individual core items
for ((i=0; i<$NUM_CORES; i++)); do
    sketchybar --add item cpu.core$i right \
               --set cpu.core$i label="0" \
                        padding_left=0 \
                        padding_right=0
done

# Only subscribe the FIRST core to the script (it updates all cores)
sketchybar --add event cpu_update \
           --subscribe cpu.core0 cpu_update \
           --set cpu.core0 update_freq=10 \
                    script="$PLUGIN_DIR/cpu.sh"

# ============================================================================
# Auto-Hide Functionality
# ============================================================================

# Add custom events for cursor position monitoring
sketchybar --add event cursor_at_top \
           --add event cursor_away_from_top

# Add hidden item to handle auto-hide events
sketchybar --add item auto_hide_trigger left \
           --set auto_hide_trigger \
                 drawing=off \
                 script="$PLUGIN_DIR/auto_hide.sh" \
           --subscribe auto_hide_trigger cursor_at_top cursor_away_from_top

# Start cursor monitor in background
CURSOR_MONITOR_DIR="$HOME/.config/sketchybar/helpers"
CURSOR_MONITOR_APP="$CURSOR_MONITOR_DIR/cursor_monitor.app/Contents/MacOS/cursor_monitor"
CURSOR_MONITOR_SWIFT="$CURSOR_MONITOR_DIR/cursor_monitor.swift"

# Kill any existing cursor monitor processes
pkill -f "cursor_monitor" 2>/dev/null

# Prefer signed app bundle (proper macOS integration), fall back to Swift script
if [ -x "$CURSOR_MONITOR_APP" ]; then
    # Use signed app bundle (shows as "Cursor Monitor" in accessibility settings)
    "$CURSOR_MONITOR_APP" &>/dev/null &
elif [ -f "$CURSOR_MONITOR_SWIFT" ]; then
    # Fall back to interpreted Swift script
    "$CURSOR_MONITOR_SWIFT" &>/dev/null &
fi

# ============================================================================
# Finalize
# ============================================================================

sketchybar --update
