#!/usr/bin/env bash
# Pre-commit hook: updates _tracker.csv for changed idea folders
# Activated via: git config core.hooksPath _scripts/hooks

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
TRACKER="$REPO_ROOT/_tracker.csv"

# Exit early if tracker doesn't exist
[[ -f "$TRACKER" ]] || exit 0

TODAY=$(date +%Y-%m-%d)

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Extract unique root-level folders from staged files (excluding _* prefixed)
changed_folders=()
while IFS= read -r file; do
    # Get the root folder (first path component)
    folder="${file%%/*}"
    # Skip if it's a file at root level (no slash) or underscore-prefixed
    [[ "$file" == */* ]] || continue
    [[ "$folder" == _* ]] && continue
    # Add to array if not already present
    if [[ ! " ${changed_folders[*]:-} " =~ " $folder " ]]; then
        changed_folders+=("$folder")
    fi
done <<< "$staged_files"

# Exit if no idea folders changed
[[ ${#changed_folders[@]} -eq 0 ]] && exit 0

# Update tracker for each changed folder
for folder in "${changed_folders[@]}"; do
    # Check if folder exists in tracker
    if ! grep -q "^$folder," "$TRACKER"; then
        # New folder - add it
        echo "$folder,\"\",\"\",$TODAY,$TODAY,1" >> "$TRACKER"
        echo >&2 "Tracker: Added new folder '$folder'"
    else
        # Update existing entry: increment sessions, update modified date
        # Using awk for in-place-like update
        awk -v folder="$folder" -v today="$TODAY" -F',' 'BEGIN {OFS=","}
            NR==1 {print; next}
            $1==folder {
                sessions=$6+1
                print $1,$2,$3,$4,today,sessions
                next
            }
            {print}
        ' "$TRACKER" > "$TRACKER.tmp" && mv "$TRACKER.tmp" "$TRACKER"
    fi

    # Check for missing tags/description and print reminders
    entry=$(grep "^$folder," "$TRACKER")
    tags=$(echo "$entry" | cut -d',' -f2)
    desc=$(echo "$entry" | cut -d',' -f3)

    if [[ "$tags" == '""' || -z "$tags" ]]; then
        echo >&2 "Reminder: '$folder' has no tags set"
    fi
    if [[ "$desc" == '""' || -z "$desc" ]]; then
        echo >&2 "Reminder: '$folder' has no description"
    fi

    # MQ validation: check for Status marker in README
    readme="$REPO_ROOT/$folder/README.md"
    if [[ -f "$readme" ]] && command -v mq &>/dev/null; then
        status_found=$(mq '.' "$readme" 2>/dev/null | grep -c "Status:" || echo 0)
        if [[ "$status_found" -eq 0 ]]; then
            echo >&2 "Reminder: '$folder/README.md' has no Status marker"
        fi
    fi
done

# Stage the updated tracker
git add "$TRACKER"

exit 0
